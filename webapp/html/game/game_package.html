<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>礼包详情</title>
    <meta name="viewport"
          content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <link rel="stylesheet" href="/css/game/reset.css">
    <link rel="stylesheet" href="/css/game/game_help.css">
    <script src="/js/game_font_size.js" type="text/javascript"></script>
    <script src="/js/jquery.min.js" type="text/javascript"></script>
    <script src="/js/common.js" type="text/javascript"></script>
</head>
<body>
<div class="wrapper">
    <header class="header_game">
        <div class="head_logo">
            <img id="imgGameIcon" src="" alt="">
        </div>
        <h5 class="gameName" id="giftPackageName"></h5>
        <p class="package_time">
            <span>有效期：</span>
            <i id="startTime"></i>
            -
            <i id="endTime"></i>
        </p>
        <p class="package_num_surplus">剩余</p>
        <p class="package_num_red"><i id="gift_count"></i>个</p>

    </header>
    <!-- /header -->
    <section class="section_package">
        <div class="package_connect">
            <h3>礼包内容</h3>
            <div class="package_connect_box">
                <p id="giftContent"></p>
            </div>
        </div>
        <div class="package_connect package_connect_bordernone">
            <h3>使用方法</h3>
            <div class="package_connect_box">
                <p id="giftDesc"></p>
            </div>
        </div>
    </section>
    <!-- /section -->

    <div class="game_button">
        <a onclick="giftCodeCopy()" id="giftCodeCopy">复制礼包</a>
        <a onclick="downloadGame()" id="gameType">立即下载</a>
    </div>
    <!--/button-->

    <input id="gameUrl" type="hidden">
    <input id="gameId" type="hidden">
</div>

<script type="text/javascript">
    // 对Date的扩展，将 Date 转化为指定格式的String
    // 月(M)、日(d)、小时(h)、分(m)、秒(s)、季度(q) 可以用 1-2 个占位符，
    // 年(y)可以用 1-4 个占位符，毫秒(S)只能用 1 个占位符(是 1-3 位的数字)
    // 例子：
    // (new Date()).Format("yyyy-MM-dd hh:mm:ss.S") ==> 2006-07-02 08:09:04.423
    // (new Date()).Format("yyyy-M-d h:m:s.S")      ==> 2006-7-2 8:9:4.18
    Date.prototype.Format = function (fmt) { //author: meizz
        var o = {
            "M+": this.getMonth() + 1,                 //月份
            "d+": this.getDate(),                    //日
            "h+": this.getHours(),                   //小时
            "m+": this.getMinutes(),                 //分
            "s+": this.getSeconds(),                 //秒
            "q+": Math.floor((this.getMonth() + 3) / 3), //季度
            "S": this.getMilliseconds()             //毫秒
        };
        if (/(y+)/.test(fmt))
            fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
        for (var k in o)
            if (new RegExp("(" + k + ")").test(fmt))
                fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
        return fmt;
    };

    /**
     * 时间格式
     * @param timestamp
     * @returns {*}
     */
    function timestampFormat(timestamp) {
        return (new Date(timestamp)).Format('yyyy-MM-dd');
    }

    $(function () {
        getGiftPackageById();
    });

    /**
     * 根据礼包id获取礼包信息
     */
    function getGiftPackageById() {
        var giftPackageId = getUrlParam("id");
        if (!giftPackageId) {
            return;
        }
        $.ajax({
            url: '/game/get_gift_package_by_id',
            type: 'GET',
            dataType: 'json',
            data: {
                giftPackageId: giftPackageId
            },
            success: function (data) {
                if (data.status == 0) {
                    var item = data.data.giftpackage;
                    $('#giftPackageName').html(item.giftPackageName);
                    var giftCount = item.total - item.takeCount;
                    if (giftCount == 0) {
                        $('#giftCodeCopy').hide();
                    }
                    $('#gift_count').html(giftCount);
                    $('#startTime').html(timestampFormat(item.startTime));
                    $('#endTime').html(timestampFormat(item.endTime));
                    var content =  JSON.parse(item.gameDesc);
                    $('#giftContent').html(content.giftContent);
                    $('#giftDesc').html(content.giftDesc);
                    checkEndTime(item.endTime);
                    getGameInfoById(item.gameInfoId);
                }
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {

            }
        });
    }

    function checkEndTime(time) {
        var now = new Date();
        if (timestampFormat(now) > timestampFormat(time)) {
            $('#giftCodeCopy').css('display', 'none');
            alert('抱歉,礼包已经过期');
        }
    }


    /**
     * 根据游戏id获取游戏详情
     * @param gameId
     */
    function getGameInfoById(gameId) {
        $.ajax({
            url: '/game/get_by_id',
            type: 'GET',
            dataType: 'json',
            data: {
                gameId: gameId
            },
            success: function (data) {
                if (data.status == 0) {
                    var item = data.data.gameinfo;
                    $('#gameId').val(item.id);
                    $('#gameUrl').val(item.gameUrl);
                    var gameType = item.gameType;
                    if (gameType == 0) {
                        $('#gameType').html('去玩游戏');
                    } else if (gameType == 1) {
                        $('#gameType').html('立即下载');
                    }
                    if (item.gameIcon.indexOf('://') > 0) {
                        $('#imgGameIcon').attr('src', item.gameIcon);
                    } else {
                        $('#imgGameIcon').attr('src', IMG_URL + item.gameIcon);
                    }
                }
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {

            }
        });
    }
    /**
     * 复制礼包
     */
    function giftCodeCopy() {
        var sessionId = getCookie('sessionId');
        var giftPackageId = getUrlParam("id");
        $.ajax({
            url: '/game/gift_code_copy',
            type: 'GET',
            dataType: 'json',
            data: {
                giftPackageId: giftPackageId,
                sessionId: sessionId
            },
            success: function (data) {
                if (data.status == 0) {
                    var giftcode = data.data.giftcode;
                    window.location.href = 'ruweapp://common/copy?text=' + giftcode.exchangeCode;
                    getGiftPackageById();
                }
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {

            }
        });
    }

    /**
     * 点击下载
     */
    function downloadGame() {
        window.location.href = 'ruweapp://game/detail?Id=' + $('#gameId').val();
    }

    function getCookie(name) {
        var arr, reg = new RegExp("(^| )" + name + "=([^;]*)(;|$)");
        if (arr = document.cookie.match(reg)) {
            return unescape(arr[2]);
        }
        return null;
    }
</script>
</body>
</html>